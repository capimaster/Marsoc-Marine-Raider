//BasicBuildings = ["Land_LightHouse_F","Land_Lighthouse_small_F","Land_Metal_Shed_F","Land_Offices_01_V1_F","Land_Slum_House01_F","Land_Slum_House02_F","Land_Slum_House03_F","Land_Unfinished_Building_01_F","Land_Unfinished_Building_02_F","Land_d_House_Big_01_V1_F","Land_d_House_Big_02_V1_F","Land_d_House_Small_02_V1_F","Land_d_Stone_HouseBig_V1_F","Land_d_Stone_HouseSmall_V1_F","Land_d_Stone_Shed_V1_F","Land_dp_mainFactory_F","Land_i_House_Big_01_V1_F","Land_i_House_Big_01_V2_F","Land_i_House_Big_01_V3_F","Land_i_House_Big_02_V1_F","Land_i_House_Big_02_V2_F","Land_i_House_Big_02_V3_F","Land_i_House_Small_01_V1_F","Land_i_House_Small_01_V2_F","Land_i_House_Small_01_V3_F","Land_i_House_Small_02_V1_F","Land_i_House_Small_02_V2_F","Land_i_House_Small_02_V3_F","Land_i_House_Small_03_V1_F","Land_i_Stone_HouseBig_V1_F","Land_i_Stone_HouseBig_V2_F","Land_i_Stone_HouseBig_V3_F","Land_i_Stone_HouseSmall_V1_F","Land_i_Stone_HouseSmall_V2_F","Land_i_Stone_HouseSmall_V3_F","Land_u_House_Big_01_V1_F","Land_u_House_Big_02_V1_F","Land_u_House_Small_01_V1_F","Land_u_House_Small_02_V1_F","Land_cargo_house_slum_F","Land_jbad_House_1_old","Land_jbad_House_3_old","Land_jbad_House_4_old","Land_jbad_House_6_old","Land_jbad_House_7_old","Land_jbad_House_8_old","Land_jbad_House_9_old","Land_lbad_House_c_1_v2","Land_jbad_House_c_11","Land_jbad_House_c_1","Land_jbad_House_c_2","Land_jbad_House_c_3","Land_jbad_House_c_4","Land_jbad_House_c_5","Land_jbad_House_c_5_v1","Land_jbad_House_c_5_v2","Land_jbad_House_c_5_v3","Land_jbad_House_1","Land_jbad_House_3","Land_jbad_House_5","Land_jbad_House_6","Land_jbad_House_7","Land_jbad_House_8","Land_jbad_House2_basehide","Land_House_C_5_EP1","Land_House_C_5_V1_EP1","Land_House_C_5_V2_EP1","Land_House_C_5_V3_EP1","Land_House_C_12_EP1","Land_House_K_1_EP1","Land_House_K_3_EP1","Land_House_K_5_EP1","Land_House_L_8_EP1","Land_House_K_6_EP1","Land_House_K_7_EP1","Land_House_K_8_EP1","Land_House_L_1_EP1","Land_House_L_4_EP1","Land_House_L_6_EP1","Land_House_L_7_EP1","Land_House_L_8_EP1","Land_jbad_House_1_old","Land_jbad_House_3_old","Land_jbad_House_4_old","Land_jbad_House_6_old","Land_jbad_House_7_old","Land_jbad_House_8_old","Land_jbad_House_9_old","Land_lbad_House_c_1_v2","Land_jbad_House_c_11","Land_jbad_House_c_1","Land_jbad_House_c_2","Land_jbad_House_c_3","Land_jbad_House_c_4","Land_jbad_House_c_5","Land_jbad_House_c_5_v1","Land_jbad_House_c_5_v2","Land_jbad_House_c_5_v3","Land_jbad_House_1","Land_jbad_House_3","Land_jbad_House_5","Land_jbad_House_6","Land_jbad_House_7","Land_jbad_House_8","Land_jbad_House2_basehide","Land_Shed_02_F","Land_House_Small_02_F","Land_House_Small_03_F","Land_House_Small_04_F","Land_House_Small_05_F","Land_House_Small_06_F","Land_House_Big_01_F","Land_House_Big_02_F","Land_House_Big_03_F","Land_House_Big_05_F","Land_Shed_05_F","Land_Shed_06_F","Land_Shed_07_F","Land_Addon_04_F","Land_Shop_City_03_F","Land_Shop_City_05_F","Land_Shop_City_06_F","Land_Shop_City_07_F","Land_House_Big_04_F","Land_House_Native_01_F","Land_House_Native_02_F","Land_House_Native_03_F","Land_House_Native_04_F","Land_House_Native_05_F","Land_House_Native_06_F","Land_blud_hut1","Land_blud_hut2","Land_blud_hut3","Land_blud_hut4","Land_blud_hut5","Land_blud_hut6","Land_blud_hut7","Land_blud_hut8","Land_MBG_GER_RHUS_5","Land_MBG_ATC_Base","Land_MBG_GER_RHUS_2","Land_MBG_GER_HUS_1","Land_MBG_ATC_Segment","Land_MBG_GER_RHUS_1","Land_MBG_GER_HUS_2","Land_MBG_GER_RHUS_3","Land_MBG_GER_RHUS_4","Objects17","Objects18","Objects19","Objects21","Objects22","Objects23","Land_deox_House_A1","Land_deox_House_A2","Land_deox_House_B1","Land_deox_House_B2","Land_deox_House_C1","Land_deox_House_C2","Land_deox_House_D_L1","Land_deox_House_D_L2","Land_deox_House_D_L3","Land_deox_House_D_L4","Land_deox_House_D_M1","Land_deox_House_D_M2","Land_deox_House_D_M3","Land_deox_House_D_M4","Land_deox_House_D_R1","Land_deox_House_D_R3","MBG_Killhouse_3_InEditor","MBG_Killhouse_4_InEditor","MBG_Killhouse_5_InEditor","MBG_Killhouse_2_InEditor","MBG_Killhouse_5_InEditor","MBG_Killhouse_1_InEditor","land_Objects101","land_Objects77","jbad_House_c_1","jbad_House_c_1_v2","jbad_House_c_10","jbad_House_c_11","jbad_House_c_12","jbad_House_c_2","jbad_House_c_3","jbad_House_c_4","jbad_House_c_5","jbad_House_c_5_v1","jbad_House_c_5_v2","jbad_House_c_5_v3","jbad_House_c_9","jbad_dum_istan2","jbad_dum_istan4","Jbad_A_Villa","jbad_House_3_old_h","Jbad_A_BuildingWIP","Jbad_Ind_Workshop01_L","Jbad_A_Stationhouse","Jbad_Mil_Barracks","Jbad_Mil_ControlTower","Jbad_Mil_Guardhouse","Jbad_Mil_House","jbad_mosque_big_addon","jbad_mosque_big_hq","Jbad_A_Mosque_small_1","Land_Jbad_A_Mosque_small_1","Jbad_A_Mosque_small_2"];	
//FriendlyRadioSounds = ["ambient_radio3","ambient_radio4","ambient_radio5","ambient_radio6","ambient_radio7","ambient_radio9","ambient_radio14","ambient_radio17","ambient_radio19","ambient_radio21","ambient_radio22","ambient_radio23","ambient_radio25","ambient_radio26","ambient_radio27","ambient_radio28","ambient_radio29","ambient_radio30"];
//hint "A";

_bloodPools = ["BloodPool_01_Large_New_F","BloodSplatter_01_Large_New_F"];

//use IDAP with police car???

fnc_AddToDirection = {
	params ["_origDirection","_addToDirection"];

	_iResult = _origDirection + _addToDirection;
	//hint format["result:%1",_iResult];
	//sleep 2;
	if (_iResult > 360) then {
		_iResult = _iResult - 360;
	};
	if (_origDirection+_addToDirection < 0) then {
		_iResult = 360 + _iResult ;
	};

	_iResult;
};	

_vehs = FriendlyUnarmedCar + FriendlyMedicalTruck + FriendlyArmoredCar + FriendlyFuelTruck + FriendlyFuelTruck + FriendlyFuelTruck;


_posOfAO =  _this select 0;

_nearestRoads = _posOfAO nearRoads 3000;
if (!(isNil "IsTraining")) then {
	_nearestRoads = _posOfAO nearRoads 30000;		
};

if (count _nearestRoads > 0) then {	

	_eventLocationPos = getPos (selectRandom _nearestRoads);

	if (selectRandom [true,false,false]) then {
		[_eventLocationPos] execVM "RandFramework\createWaitingAmbush.sqf";
		if (selectRandom[true,false]) then {
			[_eventLocationPos] execVM "RandFramework\createWaitingSuicideBomber.sqf";
		};
	};
	if (selectRandom [true,false,false]) then {
		[_eventLocationPos] execVM "RandFramework\createWaitingSuicideBomber.sqf";
	};

	_thisAreaRange = 50;
	_iteration = 1;

	while {_iteration <= 3} do {
		//hint str(_iteration);
		if (_iteration == 2) then {
			_thisAreaRange = 50;
		};
		//hint str(_thisAreaRange);

		_nearestRoads = _eventLocationPos nearRoads _thisAreaRange;

		_nearestRoad = nil;
		_roadConnectedTo = nil;


		_connectedRoad = nil;
		_direction = nil;
		//hint "2";
		//sleep 1;

		_PosFound = false;
		_iAttemptLimit = 5;



		_direction = nil;
		while {!_PosFound && _iAttemptLimit > 0 && count _nearestRoads > 0} do {
			_nearestRoad = selectRandom _nearestRoads;
			_roadConnectedTo = roadsConnectedTo _nearestRoad;
			if (count _roadConnectedTo > 0) then {	
				_connectedRoad = _roadConnectedTo select 0;
				_direction = [_nearestRoad, _connectedRoad] call BIS_fnc_DirTo;	
				_PosFound = true;		
			}
			else {
				_iAttemptLimit = _iAttemptLimit - 1;
			};
		};
	//hint format["A: %1 - %2",_iteration,_eventLocationPos];
		if (_PosFound) then {

			_roadBlockPos =  getPos _nearestRoad;
			_roadBlockSidePos = _nearestRoad getPos [10, ([_direction,90] call fnc_AddToDirection)];

			_mainVeh = createVehicle [selectRandom _vehs,_roadBlockPos,[],0,"NONE"];
			_mainVeh setHit ["karoserie",0.75];
			//_mainVeh setVehicleLock "LOCKED";
			_mainVehDirection =  ([_direction,(selectRandom[0,-10,10])] call fnc_AddToDirection);
			_mainVeh setDir _mainVehDirection;
			clearItemCargoGlobal _mainVeh;
			[
				_mainVeh,
				["CivAmbulance",1], 
				["Door_1_source",1,"Door_2_source",0,"Door_3_source",0,"Door_4_source",1,"Hide_Door_1_source",0,"Hide_Door_2_source",0,"Hide_Door_3_source",0,"Hide_Door_4_source",0,"lights_em_hide",1,"ladder_hide",1,"spare_tyre_holder_hide",1,"spare_tyre_hide",1,"reflective_tape_hide",0,"roof_rack_hide",0,"LED_lights_hide",0,"sidesteps_hide",0,"rearsteps_hide",0,"side_protective_frame_hide",1,"front_protective_frame_hide",1,"beacon_front_hide",0,"beacon_rear_hide",0]
			] call BIS_fnc_initVehicle;

			if (_iteration == 1) then {
				[_mainVeh] spawn {
					_mainVeh = _this select 0;
					while{ (alive _mainVeh)} do {
						playSound3D ["A3\Sounds_F\sfx\radio\" + selectRandom FriendlyRadioSounds + ".wss",_mainVeh,false,getPosASL _mainVeh,0.5,1,0];
						sleep selectRandom [10,15,20,30];
					};
				};

				if (!(isNil "IsTraining")) then {
					_markerEventMedi = createMarker [format["_markerEventMedi%1",(floor(random 360))], getPos _mainVeh];
					_markerEventMedi setMarkerShape "ICON";
					_markerEventMedi setMarkerType "hd_dot";
					_markerEventMedi setMarkerText "Ambushed Friendly Convoy";				
				}		
				else {
					if (selectRandom[true,false,false,false]) then {
					//if (selectRandom[true]) then {
						_markerEventMedi = createMarker [format["_markerEventMedi%1",(floor(random 360))], getPos _mainVeh];
						_markerEventMedi setMarkerShape "ICON";
						_markerEventMedi setMarkerType "hd_dot";
						_markerEventMedi setMarkerText "Distress Signal";				
					};
				};

			};

	if (selectRandom [true,false]) then {
		[_mainVeh] spawn {
			_mainVeh = _this select 0;
			while{ (alive _mainVeh)} do {
				
				_flareposX = getPos _mainVeh select 0;
				_flareposY = getPos _mainVeh select 1;
				_flare1 = "F_40mm_red" createvehicle [_flareposX+20,_flareposY+20, 250]; _flare1 setVelocity [0,0,-10];

				sleep selectRandom [600];
			}
			
		};
	};

	

	if (isnil "fncMedicalParamedicLight") then {
		fncMedicalParamedicLight = {
			params ["_downedCivMedic"];
			_medicLight = "#lightpoint" createVehicle getpos _downedCivMedic; 
			_medicLight setLightColor [255, 255, 255]; //red
			_medicLight setLightBrightness 0.03;
			_medicLight setLightAmbient [0.5,0.5,0.8];
			_medicLight lightAttachObject [_downedCivMedic, [0, 1, 1]];
			
		};
		publicVariable "fncMedicalParamedicLight";
	};

			[_mainVeh] remoteExec ["fncMedicalFlashLights", 0, true];


			_vehPos = getPos _mainVeh;
			_backOfVehArea = _vehPos getPos [5,([_mainVehDirection,floor(random 360)] call fnc_AddToDirection)];
			//_direction is direction of road
			//_mainVehDirection is direction of first veh
			//use these to lay down guys, cones, rubbish, barriers, lights etc...

			//hint str(_backOfVehArea);
			_group = createGroup civilian; 
			_downedCiv = _group createUnit [selectRandom FriendlyCheckpointUnits,_backOfVehArea,[],0,"NONE"];
			_downedCiv setDamage 0.8;
			[_downedCiv, "Acts_CivilInjuredGeneral_1"] remoteExec ["switchMove", 0];
			//_downedCiv playMoveNow "Acts_CivilInjuredGeneral_1"; //"AinjPpneMstpSnonWrflDnon";
			_downedCiv disableAI "anim";  
			_downedCivDirection = (floor(random 360));
			_downedCiv setDir (_downedCivDirection);
			_downedCiv addEventHandler ["killed", {_this execVM "RandFramework\CivKilled.sqf";}];
			_bloodPool1 = createVehicle [selectRandom _bloodPools, getpos _downedCiv, [], 0, "CAN_COLLIDE"];
			_bloodPool1 setDir (floor(random 360));
			if (selectRandom[true]) then {
				_trialDir = (floor(random 360));
				_trialPos = (getPos _bloodPool1) getPos [3,_trialDir];
				_bloodTrail1 = createVehicle ["BloodTrail_01_New_F", _trialPos, [], 0, "CAN_COLLIDE"];
				_bloodTrail1 setDir _trialDir;
			};

			[_downedCiv] spawn {
				_downedCiv = _this select 0;
				while{ (alive _downedCiv)} do {
					_downedCiv say3D selectRandom WoundedSounds;
					sleep selectRandom [2,2.5,3];
				}
				
			};



			//Paramedics object1 attachTo [object2, offset, memPoint]
			//_group = createGroup civilian; 
			_downedCivMedic = _group createUnit [selectRandom FriendlyCheckpointUnits,_backOfVehArea,[],0,"CAN_COLLIDE"];
			_downedCivMedic playmove "Acts_TreatingWounded02";
			_downedCivMedic disableAI "anim";  
			_downedCivMedic attachTo [_downedCiv, [0.5,-0.3,-0.1]];
			_downedCivMedic setDir 270;
			_downedCivMedic addEventHandler ["killed", {_this execVM "RandFramework\ParamedicKilled.sqf";}]; //ParamedicKilled

			[_downedCiv,["Carry",{
				_civ=_this select 0; 
				_player=_this select 1;
				[_civ, _player] execVM "RandFramework\CarryAndJoinWounded.sqf";				
			}]] remoteExecCall ["addAction", 0]; 
			[_downedCiv] spawn {
				_downedCiv = _this select 0;
				_doLoop = true;
				while {_doLoop} do
				{
					if (!alive(_downedCiv)) then {
						_doLoop = false;
					};
					if (_downedCiv distance (getMarkerPos "mrkHQ") < 500) then {
						_doLoop = false;
						["Wounded unit returned to base"] remoteExecCall ["Hint", 0];
						[0.1, format["Brought wounded %1 to base",name _downedCiv]] execVM "RandFramework\AdjustMaxBadPoints.sqf";
						[_downedCiv] join grpNull;
						deleteVehicle _downedCiv;
					};
					sleep 10;

				};
			};

			[_downedCivMedic] remoteExec ["fncMedicalParamedicLight", 0, true];

			_Crater = createVehicle ["Crater", _backOfVehArea, [], 20, "CAN_COLLIDE"];
			
			if (_iteration == 1) then {
								
				_downedCivMedic2 = _group createUnit [selectRandom FriendlyCheckpointUnits,_backOfVehArea,[],8,"NONE"];
				_downedCivMedic2 playmove "Acts_CivilListening_2";
				_downedCivMedic2 disableAI "anim";  
				_downedCivMedic2 addEventHandler ["killed", {_this execVM "RandFramework\ParamedicKilled.sqf";}]; //ParamedicKilled

				//_RequestedMedicalItems

				_downedCiv2 = _group createUnit [selectRandom FriendlyCheckpointUnits,getpos _downedCivMedic2,[],2,"NONE"];
				_downedCiv2 playmove "Acts_CivilTalking_2";
				_downedCiv2 disableAI "anim";  
				_downedCiv2 addEventHandler ["killed", {_this execVM "RandFramework\CivKilled.sqf";}]; //ParamedicKilled
				[[_downedCiv2, ["Ask if needs assistance",{hint "We need to get our wounded out of here, help us get these guys back to base!!"},[_downedCiv2]]],"addAction",true,true] call BIS_fnc_MP;
				_directionFromMed2ToCiv2 = [_downedCivMedic2, _downedCiv2] call BIS_fnc_DirTo; 
				_downedCivMedic2 setDir _directionFromMed2ToCiv2;	
				_directionFromCiv2ToMed2 = [_downedCiv2, _downedCivMedic2] call BIS_fnc_DirTo; 
				_downedCiv2 setDir _directionFromCiv2ToMed2;	

				/*[_downedCiv2] spawn {
					_downedCiv2 = _this select 0;
					waitUntil {behaviour _downedCiv2 == "combat"};
					_downedCiv2 call BIS_fnc_ambientAnim__terminate;
				};*/


			};
			if (_iteration == 2) then {
				

				_downedCiv3 = _group createUnit [selectRandom FriendlyCheckpointUnits,_backOfVehArea,[],25,"NONE"];
				_downedCiv3 playmove "Acts_CivilShocked_1";
				_downedCiv3 disableAI "anim";  
				_downedCiv3 setDir (floor(random 360));
				_downedCiv3 addEventHandler ["killed", {_this execVM "RandFramework\CivKilled.sqf";}]; //ParamedicKilled
			};

			_rubbish1 = createVehicle [selectRandom MedicalMessItems, getpos _downedCiv, [], 1.5, "CAN_COLLIDE"];
			_rubbish1 setDir (floor(random 360));

			_rubbish2 = createVehicle [selectRandom MedicalMessItems, getpos _downedCiv, [], 1.5, "CAN_COLLIDE"];
			_rubbish2 setDir (floor(random 360));


			//_upRoadPos = _vehPos getpos [10,_direction];
			_nearestRoadsPoint2 = _vehPos nearRoads 25;	
			_maxRoads2 = count _nearestRoadsPoint2;
			_selIndex = selectRandom [0,(_maxRoads2-1)];
			_nearestRoad2 = _nearestRoadsPoint2 select 0;
			_roadConnectedTo2 = roadsConnectedTo _nearestRoad2;
			

			_flatPos = nil;
			_flatPos = [_vehPos , 10, 15, 10, 0, 0.3, 0,[],[[0,0,0],[0,0,0]]] call BIS_fnc_findSafePos;



			_buildings = nearestObjects [_vehPos, BasicBuildings, 100];
			//hint str(count _buildings);
			if (count _buildings < 5 && _iteration == 1) then {
				_car1 = createVehicle [selectRandom _vehs, _flatPos, [], 0, "CAN_COLLIDE"];
				_car1 setDamage [1,false];
				_car1 setDir (floor(random 360));
				_objFlame1 = createVehicle ["test_EmptyObjectForFireBig", _flatPos, [], 0, "CAN_COLLIDE"];

			};

			
			//CivCars

		
		};



		_iteration = _iteration + 1;
	};



			
};

	


