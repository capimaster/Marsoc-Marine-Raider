//BasicBuildings = ["Land_LightHouse_F","Land_Lighthouse_small_F","Land_Metal_Shed_F","Land_Offices_01_V1_F","Land_Slum_House01_F","Land_Slum_House02_F","Land_Slum_House03_F","Land_Unfinished_Building_01_F","Land_Unfinished_Building_02_F","Land_d_House_Big_01_V1_F","Land_d_House_Big_02_V1_F","Land_d_House_Small_02_V1_F","Land_d_Stone_HouseBig_V1_F","Land_d_Stone_HouseSmall_V1_F","Land_d_Stone_Shed_V1_F","Land_dp_mainFactory_F","Land_i_House_Big_01_V1_F","Land_i_House_Big_01_V2_F","Land_i_House_Big_01_V3_F","Land_i_House_Big_02_V1_F","Land_i_House_Big_02_V2_F","Land_i_House_Big_02_V3_F","Land_i_House_Small_01_V1_F","Land_i_House_Small_01_V2_F","Land_i_House_Small_01_V3_F","Land_i_House_Small_02_V1_F","Land_i_House_Small_02_V2_F","Land_i_House_Small_02_V3_F","Land_i_House_Small_03_V1_F","Land_i_Stone_HouseBig_V1_F","Land_i_Stone_HouseBig_V2_F","Land_i_Stone_HouseBig_V3_F","Land_i_Stone_HouseSmall_V1_F","Land_i_Stone_HouseSmall_V2_F","Land_i_Stone_HouseSmall_V3_F","Land_u_House_Big_01_V1_F","Land_u_House_Big_02_V1_F","Land_u_House_Small_01_V1_F","Land_u_House_Small_02_V1_F","Land_cargo_house_slum_F","Land_jbad_House_1_old","Land_jbad_House_3_old","Land_jbad_House_4_old","Land_jbad_House_6_old","Land_jbad_House_7_old","Land_jbad_House_8_old","Land_jbad_House_9_old","Land_lbad_House_c_1_v2","Land_jbad_House_c_11","Land_jbad_House_c_1","Land_jbad_House_c_2","Land_jbad_House_c_3","Land_jbad_House_c_4","Land_jbad_House_c_5","Land_jbad_House_c_5_v1","Land_jbad_House_c_5_v2","Land_jbad_House_c_5_v3","Land_jbad_House_1","Land_jbad_House_3","Land_jbad_House_5","Land_jbad_House_6","Land_jbad_House_7","Land_jbad_House_8","Land_jbad_House2_basehide","Land_House_C_5_EP1","Land_House_C_5_V1_EP1","Land_House_C_5_V2_EP1","Land_House_C_5_V3_EP1","Land_House_C_12_EP1","Land_House_K_1_EP1","Land_House_K_3_EP1","Land_House_K_5_EP1","Land_House_L_8_EP1","Land_House_K_6_EP1","Land_House_K_7_EP1","Land_House_K_8_EP1","Land_House_L_1_EP1","Land_House_L_4_EP1","Land_House_L_6_EP1","Land_House_L_7_EP1","Land_House_L_8_EP1","Land_jbad_House_1_old","Land_jbad_House_3_old","Land_jbad_House_4_old","Land_jbad_House_6_old","Land_jbad_House_7_old","Land_jbad_House_8_old","Land_jbad_House_9_old","Land_lbad_House_c_1_v2","Land_jbad_House_c_11","Land_jbad_House_c_1","Land_jbad_House_c_2","Land_jbad_House_c_3","Land_jbad_House_c_4","Land_jbad_House_c_5","Land_jbad_House_c_5_v1","Land_jbad_House_c_5_v2","Land_jbad_House_c_5_v3","Land_jbad_House_1","Land_jbad_House_3","Land_jbad_House_5","Land_jbad_House_6","Land_jbad_House_7","Land_jbad_House_8","Land_jbad_House2_basehide","Land_Shed_02_F","Land_House_Small_02_F","Land_House_Small_03_F","Land_House_Small_04_F","Land_House_Small_05_F","Land_House_Small_06_F","Land_House_Big_01_F","Land_House_Big_02_F","Land_House_Big_03_F","Land_House_Big_05_F","Land_Shed_05_F","Land_Shed_06_F","Land_Shed_07_F","Land_Addon_04_F","Land_Shop_City_03_F","Land_Shop_City_05_F","Land_Shop_City_06_F","Land_Shop_City_07_F","Land_House_Big_04_F","Land_House_Native_01_F","Land_House_Native_02_F","Land_House_Native_03_F","Land_House_Native_04_F","Land_House_Native_05_F","Land_House_Native_06_F","Land_blud_hut1","Land_blud_hut2","Land_blud_hut3","Land_blud_hut4","Land_blud_hut5","Land_blud_hut6","Land_blud_hut7","Land_blud_hut8","Land_MBG_GER_RHUS_5","Land_MBG_ATC_Base","Land_MBG_GER_RHUS_2","Land_MBG_GER_HUS_1","Land_MBG_ATC_Segment","Land_MBG_GER_RHUS_1","Land_MBG_GER_HUS_2","Land_MBG_GER_RHUS_3","Land_MBG_GER_RHUS_4","Objects17","Objects18","Objects19","Objects21","Objects22","Objects23","Land_deox_House_A1","Land_deox_House_A2","Land_deox_House_B1","Land_deox_House_B2","Land_deox_House_C1","Land_deox_House_C2","Land_deox_House_D_L1","Land_deox_House_D_L2","Land_deox_House_D_L3","Land_deox_House_D_L4","Land_deox_House_D_M1","Land_deox_House_D_M2","Land_deox_House_D_M3","Land_deox_House_D_M4","Land_deox_House_D_R1","Land_deox_House_D_R3","MBG_Killhouse_3_InEditor","MBG_Killhouse_4_InEditor","MBG_Killhouse_5_InEditor","MBG_Killhouse_2_InEditor","MBG_Killhouse_5_InEditor","MBG_Killhouse_1_InEditor","land_Objects101","land_Objects77","jbad_House_c_1","jbad_House_c_1_v2","jbad_House_c_10","jbad_House_c_11","jbad_House_c_12","jbad_House_c_2","jbad_House_c_3","jbad_House_c_4","jbad_House_c_5","jbad_House_c_5_v1","jbad_House_c_5_v2","jbad_House_c_5_v3","jbad_House_c_9","jbad_dum_istan2","jbad_dum_istan4","Jbad_A_Villa","jbad_House_3_old_h","Jbad_A_BuildingWIP","Jbad_Ind_Workshop01_L","Jbad_A_Stationhouse","Jbad_Mil_Barracks","Jbad_Mil_ControlTower","Jbad_Mil_Guardhouse","Jbad_Mil_House","jbad_mosque_big_addon","jbad_mosque_big_hq","Jbad_A_Mosque_small_1","Land_Jbad_A_Mosque_small_1","Jbad_A_Mosque_small_2"];	
//sCivilian = ["C_man_polo_1_F"];
//FriendlyRadioSounds = ["ambient_radio3","ambient_radio4","ambient_radio5","ambient_radio6","ambient_radio7","ambient_radio9","ambient_radio14","ambient_radio17","ambient_radio19","ambient_radio21","ambient_radio22","ambient_radio23","ambient_radio25","ambient_radio26","ambient_radio27","ambient_radio28","ambient_radio29","ambient_radio30"];
//hint "A";

params ["_posOfAO",["_isFullMap",false]];

_currentATFieldPos = [_posOfAO , 1000, 1700, 100, 0, 0.4, 0,AreasBlackList,[[0,0,0],[0,0,0]]] call BIS_fnc_findSafePos;

if (!(isNil "IsTraining") || _isFullMap) then {
	_currentATFieldPos = [_posOfAO , 30000, 1700, 100, 0, 0.4, 0,AreasBlackList,[[0,0,0],[0,0,0]]] call BIS_fnc_findSafePos;
};

if (_currentATFieldPos select 0 != 0) then {

	ATFieldPos pushBack _currentATFieldPos;

	_minesPlaced = false;
	_iCountMines = 0;
	while {!_minesPlaced} do {

		_xPos = (_currentATFieldPos select 0)-100;
		_yPos = (_currentATFieldPos select 1)-100;
		_randomPos = [_xPos+(random 200),_yPos+(random 200),0];
//APERSMine ATMine
		_objMine = createMine [selectRandom["ATMine"], _randomPos, [], 0];
		if ("TEST" == "FALSE") then {
			_markerstrcache = createMarker [format ["CacheLoc%1",_iCountMines],_randomPos];
			_markerstrcache setMarkerShape "ICON";
			_markerstrcache setMarkerType "hd_dot";
			_markerstrcache setMarkerText "";	
		};
		_iCountMines = _iCountMines + 1;
		if (_iCountMines >= 50) then {_minesPlaced = true};
	};

	if (selectRandom [true,false,false,false,false]) then {
		[_currentATFieldPos,200,250] execVM "RandFramework\createWaitingAmbush.sqf";
	};			
				
	if (selectRandom [true,false,false,false,false]) then {			
	//if (true) then {
		_mainVeh = createVehicle [selectRandom FriendlyScoutVehicles,_currentATFieldPos,[],0,"NONE"];
		_mainVeh setDir (floor random 360);
		clearItemCargoGlobal _mainVeh;		
		if (selectRandom[true,false]) then {_mainVeh setHit ["wheel_1_1_steering",1];};
			if (selectRandom[true,false]) then {_mainVeh setHit ["wheel_1_2_steering",1];};
			if (selectRandom[true,false]) then {_mainVeh setHit ["wheel_2_1_steering",1];};
			if (selectRandom[true,false]) then {_mainVeh setHit ["wheel_2_2_steering",1];};
			if (((_mainVeh getHit "wheel_1_1_steering") < 0.5) && ((_mainVeh getHit "wheel_1_2_steering") < 0.5) && ((_mainVeh getHit "wheel_2_1_steering") < 0.5) && ((_mainVeh getHit "wheel_2_2_steering") < 0.5)) then {
				_mainVeh setHit ["wheel_1_1_steering",1];
		};	

		_pos1 = _mainVeh getPos [5,(floor random 360)];
		_pos2 = _mainVeh getPos [5,(floor random 360)];
		_group = createGroup west;
		_sUnitType = selectRandom FriendlyCheckpointUnits;

		_guardUnit1 = _group createUnit [_sUnitType,_pos1,[],0,"NONE"];
		doStop [_guardUnit1];
		_guardUnit1 setDir (floor random 360);
	 	[_guardUnit1,"WATCH","ASIS"] call BIS_fnc_ambientAnimCombat;

	 	_guardUnit2 = _group createUnit [_sUnitType,_pos2,[],0,"NONE"];
		doStop [_guardUnit2];
		_guardUnit2 setDir (floor random 360);
	 	[_guardUnit2,"WATCH","ASIS"] call BIS_fnc_ambientAnimCombat;

		[[_guardUnit1, ["Ask if needs assistance",{
			_guardUnit1 = _this select 0;
			if (alive _guardUnit1) then {
				hint "We are stranded in the middle of an AT mine area.  please help move this car ovrt 100 meters in any direction from here!"
			}
			else {
				hint "Is there a reason you are trying to talk to a dead guy??"
			}
		},[_guardUnit1]]],"addAction",true,true] call BIS_fnc_MP;

	 	[_mainVeh,_guardUnit1,_group] spawn {
	 		_mainVeh = _this select 0;
	 		_guardUnit1 = _this select 1;
	 		_group = _this select 2;
		 	_bWaiting = true;
			_bWaveDone = false;
			while {_bWaiting} do {
				if (!(alive _mainVeh)) then {
					_bWaiting = false; 
				}
				else {
					if (!_bWaveDone) then {
						_nearUnits = nearestObjects [(getPos _guardUnit1), ["Man","Car","Helicopter"], 100];
						//(driver ((nearestObjects [(getPos box1), ["car"], 20]) select 0)) in switchableUnits
				  		{
				  			if ((driver _x) in switchableUnits || (driver _x) in playableUnits) then {
				  				_bWaveDone = true;
				  				
								//[] spawn {};
								[[_guardUnit1,_group],{
									_guardUnit1 = _this select 0;
									_group = _this select 1;
									_guardUnit1 enableAI "anim";
					  				_guardUnit1 switchMove "";
					  				_guardUnit1 setBehaviour "CARELESS";
									_group setSpeedMode "FULL";
									_guardUnit1 setUnitPos "UP";
								}] remoteExec ["spawn", 0];
								sleep 0.5;
								if (alive _guardUnit1) then {
									_dirToPlayer = ([_guardUnit1, _x] call BIS_fnc_DirTo);
									_moveToPos = _guardUnit1 getPos [6,_dirToPlayer];
									_guardUnit1 doMove _moveToPos;	
									sleep 3;
									_guardUnit1 setDir _dirToPlayer;
									[_guardUnit1, ""] remoteExec ["switchMove", 0];
									sleep 0.1;
									[_guardUnit1, "Acts_JetsShooterNavigate_loop"] remoteExec ["switchMove", 0];
									_guardUnit1 disableAI "anim";  
									[_guardUnit1] spawn {
										_guardUnit1 = _this select 0;
										waitUntil {!alive(_guardUnit1)};
										[_guardUnit1, ""] remoteExec ["switchMove", 0];
									};
									sleep 20;
									_guardUnit1 enableAI "anim";
									_guardUnit1 switchMove "";
								};	
				  			};
				  		 	if (_bWaveDone) exitWith {true};
				  		} forEach _nearUnits;
				  	};
				  	if (_bWaveDone) then {
				  		if ((_mainVeh distance _guardUnit1) > 100) then {
				  			["Thank you for your help"] remoteExecCall ["Hint", 0];
				  			[_guardUnit1] remoteExecCall ["removeAllActions", 0];	
				  			[0.2, "Helped a stranded friendly"] execVM "RandFramework\AdjustMaxBadPoints.sqf";	
				  			_bWaiting = false;
				  		};
				  	};
				};
				if (_bWaiting) then {
					sleep 1;
				};
			};
		};
	};
};